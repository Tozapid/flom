AT_BANNER([TLS features check])

AT_SETUP([TLS basic setup])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([Local socket basic setup])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
AT_CHECK([flom --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem -- ls], [0], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([Local socket check peer id])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
AT_CHECK([flom --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -- ls], [0], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([TCP/IP basic setup])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem -- ls], [0], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([TCP/IP check peer id])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -- ls], [0], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([TLS client/server])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
# activate the server using CA1
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -d -1 -- true], [0], [ignore], [ignore])
# activate the client using CA1
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -- ls], [0], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([TLS different CA])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
# activate the server using CA1
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -d -1 -- true], [0], [ignore], [ignore])
# activate the client using CA2
AT_CHECK([flom -a localhost --tls-certificate=CA2/peer1_CA2_cert.pem --tls-private-key=CA2/peer1_CA2_key.pem --tls-ca-certificate=CA2/cacert.pem --tls-check-peer-id -- ls], [@_ES_GENERIC_ERROR@], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([TLS wrong server key])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
# activate the server with wrong key
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer2_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -d -1 -- true], [@_ES_GENERIC_ERROR@], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([TLS wrong client key])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
# activate the server
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -d -1 -- true], [0], [ignore], [ignore])
# activate the client with wrong key
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer2_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -- ls], [@_ES_GENERIC_ERROR@], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([TLS wrong server CA])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
# activate the server with wrong CA
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA2/cacert.pem --tls-check-peer-id -d -1 -- true], [@_ES_GENERIC_ERROR@], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP

AT_SETUP([TLS wrong client CA])
AT_CHECK([tls_setup.sh], [0], [ignore], [ignore])
# activate the server
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA1/cacert.pem --tls-check-peer-id -d -1 -- true], [0], [ignore], [ignore])
# activate the client with wrong key
AT_CHECK([flom -a localhost --tls-certificate=CA1/peer1_CA1_cert.pem --tls-private-key=CA1/peer1_CA1_key.pem --tls-ca-certificate=CA2/cacert.pem --tls-check-peer-id -- ls], [@_ES_GENERIC_ERROR@], [ignore], [ignore])
AT_CHECK([pkill flom], [ignore], [ignore], [ignore])
AT_CLEANUP


